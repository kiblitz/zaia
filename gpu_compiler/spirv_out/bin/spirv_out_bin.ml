open! Core
open Gpu_compiler

module Arg = struct
  let file =
    let info =
      Cmdliner.Arg.info
        [ "o"; "output-file" ]
        ~docv:"FILE"
        ~doc:"File to output to (default=STDOUT)"
    in
    Cmdliner.(Arg.value (Arg.opt (Arg.some Arg.filepath) None info))
  ;;
end

let output =
  let info =
    Cmdliner.Cmd.info ~doc:"for outputting spir-v code generated by zaia" "output"
  in
  let main file =
    let code =
      let header = Header.create ~id_bound:Int32.zero () in
      let capabilities = Requirements.Capabilities.create [] in
      let extensions = Requirements.Extensions.create [] in
      let instructions = [] in
      Code.create instructions ~header ~capabilities ~extensions
    in
    let with_out_channel =
      match file with
      | Some file -> Out_channel.with_file ~binary:true file
      | None ->
        fun ~f ->
          let result = f Out_channel.stdout in
          Out_channel.flush Out_channel.stdout;
          result
    in
    let buf = Bytes.create 4 in
    with_out_channel ~f:(fun out_channel ->
      Compiler.create_raw_array code
      |> ok_exn
      |> Ctypes.CArray.iter (fun word ->
        Binary_packing.pack_signed_32_int_little_endian ~buf ~pos:0 word;
        Out_channel.output_bytes out_channel buf))
  in
  Cmdliner.Cmd.v info Cmdliner.Term.(const main $ Arg.file)
;;

let command =
  let info =
    Cmdliner.Cmd.info ~doc:"cli tool for running zaia lib functions" "spirv_out_bin"
  in
  Cmdliner.Cmd.group info [ output ]
;;

let () = Cmdliner.Cmd.eval command |> exit
