open! Core
open Gpu_compiler

module Arg = struct
  let file =
    let info =
      Cmdliner.Arg.info
        [ "o"; "output-file" ]
        ~docv:"FILE"
        ~doc:"File to output to (default=STDOUT)"
    in
    Cmdliner.(Arg.value (Arg.opt (Arg.some Arg.filepath) None info))
  ;;

  let which_example =
    let info =
      Cmdliner.Arg.info
        [ "e"; "example" ]
        ~docv:"EXAMPLE"
        ~doc:"Example gpu code to compile"
    in
    let conv =
      let parser input =
        let%map.Result code =
          let mapping =
            String.Map.empty
            |> Map.set ~key:"scratch" ~data:Gpu_compiler_examples.Scratch.code
          in
          match Map.find mapping input with
          | Some code -> Ok code
          | None ->
            let expected = Map.keys mapping |> String.concat ~sep:", " in
            Result.fail
              [%string "Unknown example <%{input}>, expected one of: %{expected}"]
        in
        input, code
      in
      let pp fmt (example_name, (_ : Code.t)) = Format.fprintf fmt "%s" example_name in
      Cmdliner.Arg.Conv.make ~docv:"EXAMPLE zaia gpu code to compile" ~parser ~pp ()
    in
    Cmdliner.(Arg.required (Arg.opt (Arg.some conv) None info))
  ;;
end

let output =
  let info =
    Cmdliner.Cmd.info ~doc:"for outputting spir-v code generated by zaia" "output"
  in
  let main file (_example_name, example_code) =
    let with_out_channel =
      match file with
      | Some file -> Out_channel.with_file ~binary:true file
      | None ->
        fun ~f ->
          let result = f Out_channel.stdout in
          Out_channel.flush Out_channel.stdout;
          result
    in
    let buf = Bytes.create 4 in
    with_out_channel ~f:(fun out_channel ->
      Compiler.create_raw_array example_code
      |> ok_exn
      |> Ctypes.CArray.iter (fun word ->
        Binary_packing.pack_signed_32_int_little_endian ~buf ~pos:0 word;
        Out_channel.output_bytes out_channel buf))
  in
  Cmdliner.Cmd.v info Cmdliner.Term.(const main $ Arg.file $ Arg.which_example)
;;

let command =
  let info =
    Cmdliner.Cmd.info ~doc:"cli tool for running zaia lib functions" "spirv_out_bin"
  in
  Cmdliner.Cmd.group info [ output ]
;;

let () = Cmdliner.Cmd.eval command |> exit
